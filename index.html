<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACG èµ„æºæ•°æ®åº“ V4.4 (äº‘ç«¯AIç‰ˆ)</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card-bg: #ffffff; --border: #e2e8f0; --text: #1e293b; --sub-text: #64748b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); max-width: 1200px; margin: 0 auto; padding: 15px; color: var(--text); }
        
        /* é¡¶éƒ¨é…ç½®åŒº (æç®€ç‰ˆ) */
        .config-box { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        
        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-success { background: #dcfce7; color: #16a34a; }
        .btn-info { background: #e0f2fe; color: #0284c7; }
        .btn-ghost { background: #f1f5f9; color: #475569; }
        .btn-ghost.active { background: #cbd5e1; color: #0f172a; font-weight: bold; }
        .btn-demo { background: #fff; border: 1px dashed var(--primary); color: var(--primary); }
        .btn-demo:hover { background: #eff6ff; }

        /* æ—¥æœŸå¯¼èˆªæ  */
        .date-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; -ms-overflow-style: none; }
        .date-nav::-webkit-scrollbar { display: none; }
        .date-pill { padding: 6px 12px; border-radius: 20px; font-size: 0.85em; cursor: pointer; border: 1px solid var(--border); background: white; color: var(--sub-text); transition: 0.2s; white-space: nowrap; }
        .date-pill:hover { border-color: var(--primary); color: var(--primary); }
        .date-pill.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 5px rgba(37,99,235,0.2); }
        .date-pill.active::after { content: ' âœ“'; font-size: 0.8em; opacity: 0.8; }

        /* è¾“å…¥åŒº */
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; resize: vertical; font-family: monospace; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; line-height: 1.5; outline: none; transition: 0.2s; }
        textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
        
        /* å¸ƒå±€é€‚é… */
        .columns-wrapper { display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap; }
        .column { flex: 1; min-width: 300px; background: #fff; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; transition: 0.3s; }
        @media (max-width: 768px) { .column { min-width: 100%; max-height: 60vh; } .row { gap: 8px; } .btn { flex: 1; font-size: 0.8em; padding: 8px 10px; } }

        /* åˆ—è¡¨ä¸å¡ç‰‡ */
        .col-header { background: #f8fafc; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .col-title { font-weight: bold; font-size: 0.95em; display: flex; align-items: center; gap: 6px; }
        .badge-count { font-size: 0.8em; background: #e2e8f0; padding: 2px 8px; border-radius: 10px; color: var(--sub-text); }
        .col-content { padding: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex-grow: 1; }
        .column.collapsed { flex: 0 0 40px; min-width: 0; cursor: pointer; background: #f1f5f9; }
        .column.collapsed .col-content, .column.collapsed .col-actions, .column.collapsed .col-title span { display: none; }
        .column.collapsed .col-header { justify-content: center; padding: 10px 0; height: 100%; border: none; writing-mode: vertical-lr; }
        .column.collapsed .col-title { transform: rotate(0); }
        
        .timeline-wrapper { display: flex; flex-wrap: wrap; gap: 15px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); position: relative; border-left: 3px solid #ccc; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .card.type-code { border-left-color: #3b82f6; }
        .card.type-work { border-left-color: #ef4444; }
        .card.type-person { border-left-color: #f59e0b; }
        .card-header-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .tag { font-size: 0.65em; padding: 1px 5px; border-radius: 3px; background: #f1f5f9; color: var(--sub-text); text-transform: uppercase; }
        .card-date { font-size: 0.65em; color: #cbd5e1; font-family: monospace; }
        .card-main { font-weight: 600; font-size: 1em; margin-bottom: 4px; word-break: break-all; color: var(--text); }
        .links { display: flex; gap: 6px; flex-wrap: wrap; }
        .link-btn { text-decoration: none; font-size: 0.75em; padding: 3px 8px; border-radius: 4px; background: #f1f5f9; color: var(--text); transition: 0.1s; border: 1px solid transparent; }
        .link-btn:hover { background: #e2e8f0; border-color: #cbd5e1; }
        .link-btn.highlight { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <span style="font-weight:bold; color:#1e293b; font-size: 1.1em;">ACG èµ„æºæ•´ç†åŠ©æ‰‹</span>
        <button class="btn btn-ghost" style="padding:4px 8px; font-size:0.8em;" onclick="alert('ã€ä½¿ç”¨è¯´æ˜ã€‘\n1. å¤åˆ¶æ–‡æœ¬ï¼šå°†åŒ…å«è½¦ç‰Œã€ä½œè€…åã€ä¹¦åçš„æ··ä¹±æ–‡å­—å¤åˆ¶è¿›æ¥ã€‚\n2. ç‚¹å‡»æå–ï¼šç¨‹åºä¼šè‡ªåŠ¨è¯†åˆ«å¹¶åˆ†ç±»ã€‚\n3. æ•°æ®è‡ªåŠ¨ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ ã€‚')">â“ è¯´æ˜</button>
    </div>

    <div class="config-box">
        <div class="row" style="margin-bottom:0; justify-content: space-between;">
            <div style="display:flex; gap:10px; align-items:center;">
                <span style="font-size:0.9em; font-weight:bold;">ğŸ’¾ ç®¡ç†:</span>
                <button class="btn btn-success" onclick="exportData()">ğŸ“¤ å¯¼å‡º</button>
                <button class="btn btn-info" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥</button>
                <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(this)">
            </div>
            <button class="btn btn-danger" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div style="text-align:right; margin-bottom:5px;">
        <button class="btn btn-demo" onclick="fillDemoText()">ğŸ² å¡«å…¥è¯•ç”¨æ–‡æœ¬</button>
    </div>

    <textarea id="rawText" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬...
ğŸ‘‡ å†…ç½® AI æ™ºèƒ½è¯†åˆ«ï¼š
æ— éœ€ä»»ä½•è®¾ç½®ï¼Œç›´æ¥ç²˜è´´æ··ä¹±æ–‡æœ¬ï¼Œ
è‡ªåŠ¨è¯†åˆ« [è½¦ç‰Œå·] [ä½œè€…] [ä¹¦å] [æœç´¢æŒ‡ä»¤]"></textarea>

    <div class="row" style="margin-bottom: 15px;">
        <button class="btn btn-primary" id="processBtn" onclick="runProcessor()" style="flex:1;">
            ğŸš€ ä¸€é”®æå–å¹¶å…¥åº“
        </button>
    </div>

    <div id="dateNavigator" class="date-nav"></div>

    <div class="row" style="border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 5px;">
        <div style="display:flex; gap:10px; flex:1;">
            <button class="btn btn-ghost active" onclick="switchView('category')" id="btn-cat">ğŸ“š åˆ†ç±»è§†å›¾</button>
            <button class="btn btn-ghost" onclick="switchView('timeline')" id="btn-time">â±ï¸ æ—¶é—´è½´</button>
            <button class="btn btn-danger" onclick="openGlobal()" style="margin-left:auto;">ğŸ”¥ æ‰“å¼€å…¨éƒ¨ (å½“å‰é¡µ)</button>
        </div>
        <span id="statusLog" style="font-size:0.85em; color:var(--sub-text);">å°±ç»ª</span>
    </div>

    <div id="resultsArea" class="results-container">
        <div id="view-category" class="columns-wrapper">
            <div class="column" id="col-code">
                <div class="col-header" onclick="toggleColumn('col-code', event)">
                    <div class="col-title">ğŸ”¢ ID/è½¦ç‰Œ <span id="count-code" class="badge-count">0</span></div>
                    <div class="col-actions"><button class="btn btn-ghost" style="padding:2px 8px; font-size:0.7em;" onclick="openAll('code'); event.stopPropagation();">ğŸ”¥ä¸€é”®æ‰“å¼€</button></div>
                </div>
                <div class="col-content" id="list-code"></div>
            </div>
            <div class="column" id="col-work">
                <div class="col-header" onclick="toggleColumn('col-work', event)">
                    <div class="col-title">ğŸ® ä½œå“/ä¹¦ç± <span id="count-work" class="badge-count">0</span></div>
                    <div class="col-actions"><button class="btn btn-ghost" style="padding:2px 8px; font-size:0.7em;" onclick="openAll('work'); event.stopPropagation();">ğŸ”¥ä¸€é”®æ‰“å¼€</button></div>
                </div>
                <div class="col-content" id="list-work"></div>
            </div>
            <div class="column" id="col-person">
                <div class="col-header" onclick="toggleColumn('col-person', event)">
                    <div class="col-title">ğŸ‘¤ ä½œè€…/è§’è‰² <span id="count-person" class="badge-count">0</span></div>
                    <div class="col-actions"><button class="btn btn-ghost" style="padding:2px 8px; font-size:0.7em;" onclick="openAll('person'); event.stopPropagation();">ğŸ”¥ä¸€é”®æ‰“å¼€</button></div>
                </div>
                <div class="col-content" id="list-person"></div>
            </div>
        </div>
        <div id="view-timeline" class="timeline-wrapper hidden"></div>
    </div>

<script>
    // ==========================================
    // ğŸ”´ å…³é”®é…ç½® (è¯·ä¿®æ”¹è¿™é‡Œ)
    // ==========================================
    
    // è¯·å°†æ­¤å¤„æ›¿æ¢ä¸ºä½  Cloudflare Worker çš„å®Œæ•´åœ°å€
    // æ ¼å¼å¦‚: https://acg-proxy.ä½ çš„åå­—.workers.dev
    const WORKER_URL = "https://proud-boat-529f.rebeccademottalfre44004.workers.dev";

    // ==========================================

    let GLOBAL_DATA = [];
    let VISIBLE_DATES = new Set(); 
    const STORAGE_KEY = 'acg_db_v3';

    window.onload = function() { loadData(); updateDateVisibility('init'); };

   function fillDemoText() {
        document.getElementById('rawText').value = `è¿™å‡ å¤©æ”¶é›†çš„å¥½ä¸œè¥¿ï¼š
1. å†æ—¶122å¤©æ‰“äº†9959ä¸ªæ•Œäºº
2. è¿™ä¸ªç”»é£æ„Ÿè§‰æ˜¯Lvl3Toasterè€å¸ˆçš„#(å‘µå‘µ)
3. [Racer] Onii-chan no Hanbun...
4. [ç¦æ¼«æ¼¢åŒ–çµ„](C106)[ã¨ã‹ã¡ã®ãã«(çµæ¡ãŸã‹ã—)]kimassi(ãƒ©ãƒ–ãƒ©ã‚¤ãƒ–!)
5. è¿˜æœ‰ä¸€ä¸ªpixivå›¾ 87110616 æŒºå¥½çœ‹çš„`;
    }

    function loadData() { const saved = localStorage.getItem(STORAGE_KEY); if (saved) GLOBAL_DATA = JSON.parse(saved); }
    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(GLOBAL_DATA)); renderAll(); }

    function getFormattedDateKey(timestamp) {
        if (!timestamp) return 'æœªçŸ¥';
        const date = new Date(timestamp);
        const now = new Date();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const d = date.getDate().toString().padStart(2, '0');
        return (date.getFullYear() === now.getFullYear()) ? `${m}-${d}` : `${date.getFullYear()}-${m}-${d}`;
    }

    function updateDateVisibility(mode) {
        const allDates = [...new Set(GLOBAL_DATA.map(i => getFormattedDateKey(i.timestamp)))];
        if (allDates.length === 0) return;
        if (mode === 'init') { VISIBLE_DATES.clear(); VISIBLE_DATES.add(allDates[0]); }
        else if (mode === 'new') { VISIBLE_DATES.clear(); VISIBLE_DATES.add(getFormattedDateKey(Date.now())); }
        renderDateNav(); renderAll();
    }

    function renderDateNav() {
        const nav = document.getElementById('dateNavigator'); nav.innerHTML = '';
        const allDates = [...new Set(GLOBAL_DATA.map(i => getFormattedDateKey(i.timestamp)))];
        if (allDates.length === 0) return;
        allDates.forEach(dateKey => {
            const isActive = VISIBLE_DATES.has(dateKey);
            const pill = document.createElement('div');
            pill.className = `date-pill ${isActive ? 'active' : ''}`;
            pill.innerText = dateKey;
            pill.onclick = () => {
                if (VISIBLE_DATES.has(dateKey)) VISIBLE_DATES.delete(dateKey);
                else VISIBLE_DATES.add(dateKey);
                renderDateNav(); renderAll();
            };
            nav.appendChild(pill);
        });
    }

    function renderAll() {
        const visibleData = GLOBAL_DATA.filter(item => VISIBLE_DATES.has(getFormattedDateKey(item.timestamp)));
        document.getElementById('count-code').innerText = visibleData.filter(i => i.type === 'code').length;
        document.getElementById('count-work').innerText = visibleData.filter(i => i.type === 'work').length;
        document.getElementById('count-person').innerText = visibleData.filter(i => i.type === 'person').length;
        
        const listCode = document.getElementById('list-code');
        const listWork = document.getElementById('list-work');
        const listPerson = document.getElementById('list-person');
        const listTimeline = document.getElementById('view-timeline');
        listCode.innerHTML = ''; listWork.innerHTML = ''; listPerson.innerHTML = ''; listTimeline.innerHTML = '';

        visibleData.forEach(item => {
            const html = createCardHtml(item);
            if (item.type === 'code') listCode.insertAdjacentHTML('beforeend', html);
            if (item.type === 'work') listWork.insertAdjacentHTML('beforeend', html);
            if (item.type === 'person') listPerson.insertAdjacentHTML('beforeend', html);
            listTimeline.insertAdjacentHTML('beforeend', html);
        });
    }

    function openAll(type) {
        const items = GLOBAL_DATA.filter(i => i.type === type && VISIBLE_DATES.has(getFormattedDateKey(i.timestamp)));
        if (items.length === 0) return alert("å½“å‰è§†å›¾ä¸‹æ— å†…å®¹");
        if (items.length > 5 && !confirm(`æ‰“å¼€ ${items.length} ä¸ªé“¾æ¥ï¼Ÿ`)) return;
        items.forEach((item, idx) => { if(item.mainLink) setTimeout(() => window.open(item.mainLink, '_blank'), idx * 250); });
    }

    function openGlobal() {
        // 1. æ‰¾åˆ°å½“å‰æ—¥æœŸä¸‹ï¼Œæ‰€æœ‰æœ‰é“¾æ¥çš„å¡ç‰‡
        const items = GLOBAL_DATA.filter(i => 
            VISIBLE_DATES.has(getFormattedDateKey(i.timestamp)) && i.mainLink
        );
        
        if (items.length === 0) return alert("å½“å‰è§†å›¾ä¸‹æ²¡æœ‰å¯æ‰“å¼€çš„é“¾æ¥");
        
        // 2. å®‰å…¨ç¡®è®¤
        if (!confirm(`âš ï¸ è­¦å‘Šï¼šå³å°†æ‰“å¼€ ${items.length} ä¸ªç½‘é¡µï¼\n\nå¦‚æœæ•°é‡è¿‡å¤šï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ‹¦æˆªæˆ–å¡æ­»ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) return;

        // 3. ä¾æ¬¡æ‰“å¼€
        items.forEach((item, idx) => {
            setTimeout(() => window.open(item.mainLink, '_blank'), idx * 300); // æ¯éš”0.3ç§’å¼€ä¸€ä¸ªï¼Œé˜²æ­¢æµè§ˆå™¨å´©æºƒ
        });
    }

    function createCardHtml(item) {
        const dateKey = getFormattedDateKey(item.timestamp);
        const timeStr = new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        let linksHtml = '';
        if (item.type === 'code') linksHtml = `<a href="${item.mainLink}" target="_blank" class="link-btn highlight">ç›´è¾¾</a>`;
        else if (item.isInstruction) linksHtml = `<a href="${item.mainLink}" target="_blank" class="link-btn highlight">æ‰§è¡Œ</a>`;
        else if (item.type === 'work') linksHtml = `<a href="https://18comic.vip/search/photos?search_query=${item.content}" target="_blank" class="link-btn">ç¦æ¼«</a><a href="https://exhentai.org/?f_search=${item.content}" target="_blank" class="link-btn">EH</a><a href="https://www.google.com/search?q=${item.content}" target="_blank" class="link-btn">Google</a>`;
        else if (item.type === 'person') linksHtml = `<a href="https://www.pixiv.net/search/users?nick=${item.content}&s_mode=s_usr" target="_blank" class="link-btn highlight">Pixiv</a><a href="https://x.com/search?q=${item.content}&src=typeahead_click" target="_blank" class="link-btn">X</a>`;
        return `<div class="card type-${item.type}"><div class="card-header-row"><div class="tags"><span class="tag">${item.subType}</span></div><div class="card-date">${dateKey} ${timeStr}</div></div><div class="card-main">${item.content}</div><div class="links">${linksHtml}</div></div>`;
    }

    async function runProcessor() {
        const text = document.getElementById('rawText').value;
        if (!text) return alert("è¯·å…ˆè¾“å…¥æ–‡æœ¬");
        
        document.getElementById('processBtn').disabled = true;
        log("å¤„ç†ä¸­...");

        // 1. æœ¬åœ°æå–
        const localItems = processLocalNumbers(text);
        if(localItems.length > 0) addItems(localItems, false);

        // 2. AI æå– (é€šè¿‡ Cloudflare Worker)
        // æ³¨æ„ï¼šè¿™é‡Œä¸å†éœ€è¦æ£€æŸ¥å¯†ç ï¼Œç›´æ¥è°ƒç”¨
        if (WORKER_URL && WORKER_URL.startsWith("http")) {
            log("AI æ™ºèƒ½åˆ†æä¸­...");
            try { 
                const aiItems = await processAI(text, WORKER_URL, "deepseek-chat"); 
                if(aiItems.length > 0) addItems(aiItems, false); 
            } 
            catch (e) { log("AI å¤±è´¥: " + e.message); }
        } else {
             log("è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½® WORKER_URL");
        }
        
        if (localItems.length > 0 || (document.getElementById('statusLog').innerText.includes("AI"))) { 
            updateDateVisibility('new'); 
            log(`å®Œæˆï¼Œæ˜¾ç¤ºä»Šæ—¥æ–°å¢`); 
        } else { 
            log("å®Œæˆ (æ— æ–°å†…å®¹)"); 
        }

        document.getElementById('rawText').value = '';
        document.getElementById('processBtn').disabled = false;
    }

    function processLocalNumbers(text) {
        const results = [];
        const lines = text.split('\n');
        lines.forEach(line => {
            if (!line.trim()) return;
            let cleanLine = line.replace(/^\s*\d+[\.\ã€\s]\s*/, '');
            const explicitMatch = cleanLine.match(/\b\d{6,8}\b/);
            if (explicitMatch) {
                const id = explicitMatch[0];
                const isPixiv = id.length === 8;
                const link = isPixiv ? `https://www.pixiv.net/artworks/${id}` : `https://18comic.vip/photo/${id}`;
                results.push({ type: 'code', content: id, original: line.trim(), mainLink: link, subType: isPixiv ? 'Pixiv' : '18c' });
            } else {
                const combinedNum = cleanLine.replace(/[^0-9]/g, '');
                if (combinedNum.length >= 6 && combinedNum.length <= 8) {
                    const isPixiv = combinedNum.length === 8;
                    const link = isPixiv ? `https://www.pixiv.net/artworks/${combinedNum}` : `https://18comic.vip/photo/${combinedNum}`;
                    results.push({ type: 'code', content: combinedNum, original: line.trim(), mainLink: link, subType: isPixiv ? 'Pixiv' : '18c' });
                }
            }
        });
        return results;
    }

    async function processAI(text, workerUrl, model) {
        const systemPrompt = `Role: ACG Data Extraction Expert. Rules: 1. Return JSON ONLY. 2. Ignore line numbering. 3. Ignore 6-8 digit numbers. 4. Special Format "[Name] Title": Extract 'Name' as 'person', 'Title' as 'work'. 5. "redgifæœxxx": Extract 'redgif' as platform, 'xxx' as query. Format: { "results": [ { "type": "person", "content": "Name", "sub_type": "Artist" } ] }`;
        
        // ç›´æ¥ POST åˆ°ä½ çš„ Workerï¼Œæ— éœ€ Key
        const response = await fetch(workerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                model: model, 
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: text }], 
                response_format: { type: "json_object" } 
            })
        });
        
        const data = await response.json();
        // å¤„ç† DeepSeek è¿”å›çš„æ ‡å‡†æ ¼å¼
        const content = data.choices ? data.choices[0].message.content : JSON.stringify(data);
        const rawResults = JSON.parse(content).results || [];
        
        return rawResults.map(item => {
            item.content = item.content.replace(/^\d+[\.\s]/, '');
            let link = '';
            if (item.type === 'instruction') { item.type = 'work'; item.isInstruction = true; const p = item.platform?.toLowerCase() || ''; link = `https://www.google.com/search?q=site:${p}.com ${item.query}`; } 
            else if (item.type === 'work') link = `https://18comic.vip/search/photos?search_query=${item.content}`;
            else if (item.type === 'person') link = `https://www.pixiv.net/search/users?nick=${item.content}&s_mode=s_usr`;
            return { type: item.type, content: item.content, subType: item.sub_type || (item.isInstruction ? 'CMD' : 'Unknown'), mainLink: link, isInstruction: !!item.isInstruction, original: item.content };
        });
    }

    function addItems(newItems, autoRender = true) {
        let addedCount = 0;
        newItems.reverse().forEach(item => {
            const exists = GLOBAL_DATA.some(old => old.content === item.content);
            if (!exists) { item.timestamp = Date.now(); GLOBAL_DATA.unshift(item); addedCount++; }
        });
        if (addedCount > 0) localStorage.setItem(STORAGE_KEY, JSON.stringify(GLOBAL_DATA));
        return addedCount;
    }

    function exportData() { if (GLOBAL_DATA.length === 0) return alert("æ— æ•°æ®"); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(GLOBAL_DATA, null, 2)); const a = document.createElement('a'); a.href = dataStr; a.download = `ACG_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); }
    function importData(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const items = JSON.parse(e.target.result); addItems(items); alert("å¯¼å…¥æˆåŠŸï¼Œé¡µé¢å°†åˆ·æ–°"); updateDateVisibility('new'); } catch(e) { alert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); } input.value = ''; }; reader.readAsText(file); }
    function clearHistory() { if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) { GLOBAL_DATA = []; saveData(); updateDateVisibility('init'); } }
    
    // UI
    const getId = (id) => document.getElementById(id);
    const log = (msg) => getId('statusLog').innerText = msg;
    function switchView(mode) { getId('btn-cat').className = mode === 'category' ? 'btn btn-ghost active' : 'btn btn-ghost'; getId('btn-time').className = mode === 'timeline' ? 'btn btn-ghost active' : 'btn btn-ghost'; getId('view-category').className = mode === 'category' ? 'columns-wrapper' : 'columns-wrapper hidden'; getId('view-timeline').className = mode === 'timeline' ? 'timeline-wrapper' : 'timeline-wrapper hidden'; }
    function toggleColumn(colId, event) { if (event.target.tagName === 'BUTTON') return; getId(colId).classList.toggle('collapsed'); }
</script>
</body>
</html>



